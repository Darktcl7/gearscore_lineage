{% extends 'items/base.html' %}
{% load static %}
{% load item_extras %}

{% block title %}
{% if is_edit %}Edit Character{% else %}Create Character{% endif %}
{% endblock %}

{% block extra_body_attributes %}class="fullscreen-page"{% endblock %}

{% block extra_head %}
<style>
    /* CSS Styles for the form */
    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: auto;
        background: #0c0c0c;
    }

    #fog-background {
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
    }

    #site-content {
        min-height: 100vh;
    }

    main {
        padding: 20px;
    }

    .character-form-container {
        max-width: 1400px;
        margin: 80px auto 30px auto;
        padding: 30px;
        background: rgba(18, 18, 18, 0.85);
        border-radius: 20px;
        box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .form-header {
        padding: 15px 0;
        border-bottom: 2px solid rgba(197, 168, 0, 0.5);
        margin-bottom: 30px;
        text-align: center;
        background: transparent;
    }



    .form-header h1 {
        margin: 0;
        color: #ffffff;
        font-size: 1.25rem;
        text-shadow: 0 0 10px rgba(197, 168, 0, 0.5);
    }

    .form-content-wrapper {
        display: flex;
        flex-direction: column;
    }

    .form-section {
        display: flex;
        flex-direction: column;
        gap: 25px;
        padding: 15px;
    }

    .form-group {
        margin-bottom: 0;
        padding: 20px;
        background: linear-gradient(160deg, #3a3a3a, #2a2a2a);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        transition: all 0.4s ease;
        flex: 0 0 auto;
        position: relative;
        overflow: hidden;
    }

    .form-group:hover {
        transform: translateY(-5px) scale(1.01);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(197, 168, 0, 0.3);
    }

    .form-label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #ffffff;
        font-size: 0.85rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px 10px;
        font-size: 13px;
        border: 1px solid rgba(197, 168, 0, 0.5);
        border-radius: 8px;
        background: rgba(20, 20, 20, 0.8);
        color: white;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        box-sizing: border-box;
        transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border: 1px solid #c5a800;
        box-shadow: 0 0 10px rgba(197, 168, 0, 0.5);
    }

    .checkbox-group,
    .radio-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        padding: 5px 0;
    }

    .checkbox-label,
    .radio-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgba(40, 40, 40, 0.7);
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.05);
        text-align: center;
    }

    .checkbox-label:hover,
    .radio-label:hover {
        background: rgba(60, 60, 60, 0.8);
        border: 1px solid rgba(197, 168, 0, 0.3);
    }

    .choice-label-text {
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 0.8rem;
    }

    .choice-image {
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 5px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 5px;
        border: 2px solid rgba(197, 168, 0, 0.3);
        transition: all 0.3s ease;
    }

    .choice-image:hover {
        border-color: rgba(197, 168, 0, 0.8);
        box-shadow: 0 0 20px rgba(197, 168, 0, 0.4);
        transform: scale(1.05);
    }

    .choice-image img,
    .choice-image video {
        max-width: 100%;
        max-height: 100%;
        border-radius: 8px;
        object-fit: contain;
    }

    .question-image {
        margin-bottom: 10px;
        max-width: 64px;
    }

    .question-image img,
    .question-image video {
        width: 100%;
        border-radius: 8px;
    }

    #basic-tab .checkbox-label {
        padding: 15px;
        border-radius: 10px;
    }

    #basic-tab .choice-label-text {
        font-size: 1rem;
        margin-bottom: 10px;
    }

    #basic-tab .choice-image {
        width: 120px;
        height: 120px;
        margin-top: 10px;
        border-radius: 10px;
    }

    #basic-tab .question-image {
        max-width: 100px;
        margin-bottom: 15px;
    }

    .form-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        padding-top: 20px;
        margin-top: 30px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        background: transparent;
    }

    .form-buttons .btn {
        padding: 8px 18px;
        border-radius: 8px;
        text-decoration: none;
        color: white;
        font-size: 0.9rem;
        min-width: 100px;
        text-align: center;
        font-weight: 600;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .btn-primary {
        background: linear-gradient(145deg, #4CAF50, #3a8a3f);
    }

    .btn-secondary {
        background: linear-gradient(145deg, #000000, #2c2c2c);
    }

    .btn-primary:hover,
    .btn-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }

    .form-tabs {
        display: flex;
        flex-direction: column;
    }

    .tab-buttons {
        display: flex;
        background: rgba(20, 20, 20, 0.7);
        border-radius: 8px;
        padding: 2px 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    .tab-btn {
        padding: 10px 15px;
        border: none;
        background: transparent;
        color: #aaa;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
        color: #ffffff;
        background: rgba(255, 255, 255, 0.05);
    }

    .tab-btn.active {
        color: #c5a800;
        border-bottom: 3px solid #c5a800;
    }

    .tab-content {
        display: none;
        padding: 0;
    }

    .tab-content.active {
        display: block;
    }

    .form-section::-webkit-scrollbar {
        width: 8px;
    }

    .form-section::-webkit-scrollbar-track {
        background: rgba(20, 20, 20, 0.5);
        border-radius: 4px;
    }

    .form-section::-webkit-scrollbar-thumb {
        background: linear-gradient(#c5a800, #8a7800);
        border-radius: 4px;
    }

    /* Gear Score Stats styling */
    .stat-input-group {
        background: rgba(30, 30, 30, 0.7);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .stat-input-group:hover {
        transform: translateY(-3px);
        border: 1px solid rgba(197, 168, 0, 0.4);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    }

    .stat-input-group .form-label {
        font-size: 0.95rem;
        margin-bottom: 8px;
        color: #ddd;
    }

    .stat-input-group input[type="number"] {
        background: rgba(15, 15, 15, 0.9);
        font-size: 1.2rem;
        text-align: center;
        font-weight: 600;
        padding: 10px;
    }

    .stat-input-group select,
    .stat-input-group ul {
        background: rgba(15, 15, 15, 0.9);
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(197, 168, 0, 0.3);
        color: white;
        width: 100%;
    }

    /* Fix for radio/checkbox lists - make them horizontal and aligned */
    .stat-input-group ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .stat-input-group ul li {
        padding: 8px 16px;
        border-radius: 6px;
        margin-bottom: 0;
        background: rgba(40, 40, 40, 0.6);
        transition: all 0.2s ease;
        flex: 0 0 auto;
    }

    .stat-input-group ul li:hover {
        background: rgba(60, 60, 60, 0.8);
    }

    .stat-input-group ul li label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        color: #ddd;
        white-space: nowrap;
    }

    /* Ensure radio inputs are properly aligned */
    .stat-input-group ul li label input[type="radio"],
    .stat-input-group ul li label input[type="checkbox"] {
        margin: 0;
        width: auto;
        min-width: auto;
    }

    /* Custom Popup Notification */
    .custom-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }

    .custom-popup.show {
        display: flex;
        animation: fadeIn 0.3s ease;
    }

    .custom-popup-content {
        background: linear-gradient(145deg, #1a1a2e, #16213e);
        border: 2px solid #e94560;
        border-radius: 16px;
        padding: 30px 40px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(233, 69, 96, 0.4);
        max-width: 400px;
        animation: slideIn 0.4s ease;
    }

    .custom-popup-icon {
        font-size: 50px;
        margin-bottom: 15px;
        display: block;
    }

    .custom-popup-title {
        color: #e94560;
        font-size: 22px;
        font-weight: bold;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .custom-popup-message {
        color: #fff;
        font-size: 16px;
        margin-bottom: 25px;
        line-height: 1.5;
    }

    .custom-popup-btn {
        background: linear-gradient(145deg, #e94560, #c73e54);
        color: white;
        border: none;
        padding: 12px 35px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 25px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .custom-popup-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(233, 69, 96, 0.5);
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Custom Popup Notification -->
<div id="customPopup" class="custom-popup">
    <div class="custom-popup-content">
        <span class="custom-popup-icon">‚ö†Ô∏è</span>
        <div class="custom-popup-title">Peringatan!</div>
        <div class="custom-popup-message" id="popupMessage"></div>
        <button class="custom-popup-btn" onclick="closePopup()">Mengerti</button>
    </div>
</div>

<div class="character-form-container">
    <div class="form-header">
        <h1>
            {% if is_edit %}
            Edit {{ character_form.instance.name }}
            {% else %}
            Create New Character
            {% endif %}
        </h1>
    </div>

    <form method="post" style="display:contents;" novalidate>
        {% csrf_token %}
        
        {% if character_form.errors or attributes_form.errors %}
        <div class="alert alert-danger" style="background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <strong>There were some errors saving the form:</strong>
            <ul style="margin-top: 10px;">
                {% for field, errors in character_form.errors.items %}
                    <li>{{ field }}: {{ errors|striptags }}</li>
                {% endfor %}
                {% for field, errors in attributes_form.errors.items %}
                    <li>{{ field }}: {{ errors|striptags }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="form-content-wrapper">
            <div class="form-tabs">
                <div class="tab-buttons">
                    <button type="button" class="tab-btn active" data-tab="basic">Basic Info</button>
                    <button type="button" class="tab-btn" data-tab="gearscore">Gear Score Stats</button>
                    <button type="button" class="tab-btn" data-tab="attributes">Attributes</button>
                </div>

                <div class="tab-content active" id="basic-tab">
                    <div class="form-section">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label for="{{ character_form.name.id_for_label }}" class="form-label">Your
                                    Nickname</label>
                                {{ character_form.name }}
                            </div>
                            <div class="form-group">
                                <label for="{{ character_form.clan.id_for_label }}" class="form-label">Your Clan</label>
                                {{ character_form.clan }}
                            </div>
                            <div class="form-group">
                                <label for="{{ character_form.character_class.id_for_label }}" class="form-label">Your
                                    Class</label>
                                {{ character_form.character_class }}
                            </div>
                            <div class="form-group">
                                <label for="{{ character_form.level.id_for_label }}" class="form-label">Your LvL</label>
                                {{ character_form.level }}
                            </div>
                        </div>

                        {% for field in character_form %}
                        {% if field.name == 'mythic_classes' or field.name == 'legendary_classes' or field.name == 'legendary_agathions' or field.name == 'legendary_mounts' %}
                        <div class="form-group">
                            <label class="form-label"><strong>{{ field.label }}</strong></label>

                            {% with field_img=field.label|get_field_image %}
                            {% if field_img %}
                            <div class="question-image">
                                {% if field_img|is_video %}
                                <video src="{% static 'items/images/choices/'|add:field_img %}" autoplay muted loop
                                    class="img-fluid"></video>
                                {% else %}
                                <img src="{% static 'items/images/choices/'|add:field_img %}" alt="Question Image"
                                    class="img-fluid">
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endwith %}

                            <div class="checkbox-group">
                                {% for choice in field %}
                                <label class="checkbox-label">
                                    {{ choice.tag }}
                                    <span class="choice-label-text">{{ choice.choice_label }}</span>
                                    {% with img_name=choice.choice_label|get_image_for_choice %}
                                    {% if img_name %}
                                    <div class="choice-image">
                                        {% if img_name|is_video %}
                                        <video src="{% static 'items/images/choices/'|add:img_name %}" autoplay muted
                                            loop></video>
                                        {% else %}
                                        <img src="{% static 'items/images/choices/'|add:img_name %}"
                                            alt="{{ choice.choice_label }}">
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endwith %}
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="tab-content" id="gearscore-tab">
                    <div class="form-section">
                        <div class="form-group"
                            style="background: linear-gradient(145deg, #1a3a1a, #0d1f0d); border: 1px solid rgba(76, 175, 80, 0.3);">
                            <h3
                                style="color: #4CAF50; margin-bottom: 20px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                                <img src="{% static 'items/images/choices/Icon_WP_Sword_G3_001.png' %}" alt="Combat"
                                    style="width: 32px; height: 32px;">
                                Base Combat Stats
                            </h3>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_WP_Sword_G3_002.png' %}"
                                            alt="DMG" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">DMG (Damage)</label>
                                    </div>
                                    {{ attributes_form.stat_dmg }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_WP_Bow_G3_001.png' %}" alt="ACC"
                                            style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">ACC (Accuracy)</label>
                                    </div>
                                    {{ attributes_form.stat_acc }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_AR_Torso_G3_001.png' %}"
                                            alt="DEF" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">DEF (Defense)</label>
                                    </div>
                                    {{ attributes_form.stat_def }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_AR_Sigil_G3_001.png' %}"
                                            alt="RESIST" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">SKILL RESIST</label>
                                    </div>
                                    {{ attributes_form.stat_resist }}
                                </div>
                            </div>
                        </div>

                        <div class="form-group"
                            style="background: linear-gradient(145deg, #3a2a1a, #1f150d); border: 1px solid rgba(255, 152, 0, 0.3);">
                            <h3
                                style="color: #FF9800; margin-bottom: 20px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                                <img src="{% static 'items/images/choices/Icon_WP_Staff_G3_001.png' %}" alt="Multiplied"
                                    style="width: 32px; height: 32px;">
                                Multiplied Stats (Higher Score Impact)
                            </h3>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_AR_Cape_G3_001.png' %}"
                                            alt="REDUC" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">DMG REDUCT (√ó3)</label>
                                    </div>
                                    {{ attributes_form.stat_reduc }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_WP_Staff_G3_003.png' %}"
                                            alt="SKILL" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">SKILL DMG BOOST (√ó2)</label>
                                    </div>
                                    {{ attributes_form.stat_skill_dmg_boost }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_WP_Spear_G3_001.png' %}"
                                            alt="WPN" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">WPN DMG BOOST</label>
                                    </div>
                                    {{ attributes_form.stat_wpn_dmg_boost }}
                                </div>
                            </div>
                        </div>

                        <div class="form-group"
                            style="background: linear-gradient(145deg, #1a1a3a, #0d0d1f); border: 1px solid rgba(103, 58, 183, 0.3);">
                            <h3
                                style="color: #9C27B0; margin-bottom: 20px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                                <img src="{% static 'items/images/choices/Icon_SoulStone_Option_Icon_01.png' %}"
                                    alt="Progression" style="width: 32px; height: 32px;">
                                Progression Stats (√ó10)
                            </h3>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_SoulStone_Option_Icon_01.png' %}"
                                            alt="SOULSHOT" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">SOULSHOT Level</label>
                                    </div>
                                    {{ attributes_form.soulshot_level }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_SoulStone_Option_Icon_04.png' %}"
                                            alt="VALOR" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">VALOR Level</label>
                                    </div>
                                    {{ attributes_form.valor_level }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_SoulStone_Option_Icon_07.png' %}"
                                            alt="GUARDIAN" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">GUARDIAN</label>
                                    </div>
                                    {{ attributes_form.stat_guardian }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_AR_Helmet_G4_003.png' %}"
                                            alt="CONQUER" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">CONQUER</label>
                                    </div>
                                    {{ attributes_form.stat_conquer }}
                                </div>
                            </div>
                        </div>

                        <div class="form-group"
                            style="background: linear-gradient(145deg, #3a1a3a, #1f0d1f); border: 1px solid rgba(233, 30, 99, 0.3);">
                            <h3
                                style="color: #E91E63; margin-bottom: 20px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                                <img src="{% static 'items/images/choices/Icon_Classcard_Aria.png' %}" alt="Legend"
                                    style="width: 32px; height: 32px;">
                                Legend Points
                            </h3>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_Classcard_Scryde.png' %}"
                                            alt="Epic Classes" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">Epic Classes Count (√ó20)</label>
                                    </div>
                                    {{ attributes_form.epic_classes_count }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_Agathion_Baium.png' %}"
                                            alt="Epic Agathions" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">Epic Agathions Count (√ó20)</label>
                                    </div>
                                    {{ attributes_form.epic_agathions_count }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_Item_Usable_SkillBook_04.png' %}"
                                            alt="Codex" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">Total Legend Codex (√ó3)</label>
                                    </div>
                                    {{ attributes_form.total_legend_codex }}
                                </div>
                                <div class="stat-input-group">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <img src="{% static 'items/images/choices/Icon_Item_Usable_SkillBook_04.png' %}"
                                            alt="Epic Mount" style="width: 32px; height: 32px;">
                                        <label class="form-label" style="margin: 0;">Total Epic Mount (√ó10)</label>
                                    </div>
                                    {{ attributes_form.total_epic_mount }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="attributes-tab">
                    <div class="form-section">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            {% for field in attributes_form %}
                            {% with n=field.name %}
                            {% if not n|is_gearscore_field and not n|is_skill_field and not n|is_weapon_field and not n|is_expertise_field and n != "unlocked_skills" %}
                            <div class="form-group">
                                <label class="form-label"><strong>{{ field.label }}</strong></label>

                                {% with field_img=field.label|get_field_image %}
                                {% if field_img %}
                                <div class="question-image">
                                    {% if field_img|is_video %}
                                    <video src="{% static 'items/images/choices/'|add:field_img %}" autoplay muted loop
                                        class="img-fluid"></video>
                                    {% else %}
                                    <img src="{% static 'items/images/choices/'|add:field_img %}" alt="Question Image"
                                        class="img-fluid">
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endwith %}

                                {% with widget_class=field.field.widget|class_name %}
                                {% if widget_class == 'CheckboxSelectMultiple' %}
                                <div class="checkbox-group">
                                    {% for choice in field %}
                                    <label class="checkbox-label">
                                        {{ choice.tag }}
                                        <span class="choice-label-text">{{ choice.choice_label }}</span>
                                        {% with img_name=choice.choice_label|get_image_for_choice %}
                                        {% if img_name and field.name != 'inheritor_books' %}
                                        <div class="choice-image">
                                            {% if img_name|is_video %}
                                            <video src="{% static 'items/images/choices/'|add:img_name %}" autoplay
                                                muted loop></video>
                                            {% else %}
                                            <img src="{% static 'items/images/choices/'|add:img_name %}"
                                                alt="{{ choice.choice_label }}">
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        {% endwith %}
                                    </label>
                                    {% endfor %}
                                </div>
                                {% elif widget_class == 'RadioSelect' %}
                                <div class="radio-group">
                                    {% for choice in field %}
                                    <label class="radio-label">
                                        {{ choice.tag }}
                                        <span class="choice-label-text">{{ choice.choice_label }}</span>
                                        {% with img_name=choice.choice_label|get_image_for_choice %}
                                        {% if img_name and field.name != 'inheritor_books' %}
                                        <div class="choice-image">
                                            {% if img_name|is_video %}
                                            <video src="{% static 'items/images/choices/'|add:img_name %}" autoplay
                                                muted loop></video>
                                            {% else %}
                                            <img src="{% static 'items/images/choices/'|add:img_name %}"
                                                alt="{{ choice.choice_label }}">
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        {% endwith %}
                                    </label>
                                    {% endfor %}
                                </div>
                                {% else %}
                                {{ field }}
                                {% endif %}
                                {% endwith %}
                            </div>
                            {% endif %}
                            {% endwith %}
                            {% endfor %}
                        </div>

                        <!-- üó°Ô∏è Weapon Expertise Section -->
                        <div class="form-group" id="expertise-section"
                            style="background: linear-gradient(145deg, #1a1a2e, #0d0d1a); border: 1px solid rgba(156, 39, 176, 0.3);">
                            <label class="form-label"><strong>üó°Ô∏è Weapon Expertise</strong></label>
                            <p style="color: #aaa; font-size: 0.8rem; margin-bottom: 15px;">Set your weapon expertise ranks (0-9)</p>

                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px;">
                                <!-- One-Handed Sword -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">‚öîÔ∏è One-Handed Sword</label>
                                    {{ attributes_form.exp_one_handed_sword }}
                                </div>
                                <!-- Dual-Wield -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">‚öîÔ∏è Dual-Wield</label>
                                    {{ attributes_form.exp_dual_wield }}
                                </div>
                                <!-- Dagger -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">üó°Ô∏è Dagger</label>
                                    {{ attributes_form.exp_dagger }}
                                </div>
                                <!-- Bow -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">üèπ Bow</label>
                                    {{ attributes_form.exp_bow }}
                                </div>
                                <!-- Staff -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">ü™Ñ Staff</label>
                                    {{ attributes_form.exp_staff }}
                                </div>
                                <!-- Greatsword -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">‚öîÔ∏è Greatsword</label>
                                    {{ attributes_form.exp_greatsword }}
                                </div>
                                <!-- Crossbow -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">üèπ Crossbow</label>
                                    {{ attributes_form.exp_crossbow }}
                                </div>
                                <!-- Chainsword -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">‚õìÔ∏è Chainsword</label>
                                    {{ attributes_form.exp_chainsword }}
                                </div>
                                <!-- Rapier -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">ü§∫ Rapier</label>
                                    {{ attributes_form.exp_rapier }}
                                </div>
                                <!-- Magic Cannon -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">üí• Magic Cannon</label>
                                    {{ attributes_form.exp_magic_cannon }}
                                </div>
                                <!-- Spear -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">üî± Spear</label>
                                    {{ attributes_form.exp_spear }}
                                </div>
                                <!-- Orb -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">üîÆ Orb</label>
                                    {{ attributes_form.exp_orb }}
                                </div>
                                <!-- Dual Axe -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">ü™ì Dual Axe</label>
                                    {{ attributes_form.exp_dual_axe }}
                                </div>
                                <!-- Soul Breaker -->
                                <div style="background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px;">
                                    <label style="color: #CE93D8; font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 6px;">üíÄ Soul Breaker</label>
                                    {{ attributes_form.exp_soul_breaker }}
                                </div>
                            </div>
                        </div>

                        <!-- Weapon Selection Section -->
                        <div class="form-group" id="weapon-section"
                            style="background: linear-gradient(145deg, #2a1a0a, #1a0d05); border: 1px solid rgba(255, 152, 0, 0.3);">
                            <label class="form-label"><strong>‚öîÔ∏è Your Main Weapon</strong></label>
                            <p style="color: #aaa; font-size: 0.8rem; margin-bottom: 15px;">Select the weapon you
                                currently use (filtered by your class)</p>

                            <!-- Hidden original select fields -->
                            <div style="display: none;">
                                {{ attributes_form.weapon }}
                                {{ attributes_form.weapon_enchant }}
                            </div>

                            <div class="weapon-grid" id="weapon-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                                <!-- Weapon cards will be populated by JavaScript -->
                            </div>
                            <p id="no-weapons-msg"
                                style="color: #888; text-align: center; padding: 20px; display: none;">
                                Please select your class in "Basic Info" tab first to see available weapons.
                            </p>

                            <!-- Enchant Level Section (muncul setelah weapon dipilih) -->
                            <div id="enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255, 152, 0, 0.2);">
                                <label class="form-label" style="color: #FF9800; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-weapon-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    <!-- Enchant buttons +0 to +11 -->
                                </div>
                            </div>
                        </div>
                        <!-- PVP Necklace Selection Section -->
                        <div class="form-group" id="necklace-section"
                            style="background: linear-gradient(145deg, #2a0a1a, #1a0510); border: 1px solid rgba(233, 30, 99, 0.3);">
                            <label class="form-label"><strong>üìø PvP Necklace</strong></label>
                            <p style="color: #aaa; font-size: 0.8rem; margin-bottom: 15px;">Select your PvP Necklace</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_necklace }}
                                {{ attributes_form.pvp_necklace_enchant }}
                            </div>

                            <div class="necklace-grid" id="necklace-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="necklace-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(233, 30, 99, 0.2);">
                                <label class="form-label" style="color: #F48FB1; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-necklace-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="necklace-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                            </div>
                        </div>

                        <!-- PVP Belt Selection Section -->
                        <div class="form-group" id="belt-section"
                            style="background: linear-gradient(145deg, #1a0a2a, #0d051a); border: 1px solid rgba(156, 39, 176, 0.3);">
                            <label class="form-label"><strong>üõ°Ô∏è PvP Belt</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your PvP Belt</p>

                            <!-- Hidden original select fields -->
                            <div style="display: none;">
                                {{ attributes_form.pvp_belt }}
                                {{ attributes_form.pvp_belt_enchant }}
                            </div>

                            <div class="belt-grid" id="belt-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                                <!-- Belt cards will be populated by JavaScript -->
                            </div>

                            <!-- Belt Enchant Level Section -->
                            <div id="belt-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(156, 39, 176, 0.2);">
                                <label class="form-label" style="color: #CE93D8; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-belt-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="belt-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    <!-- Belt enchant buttons +0 to +11 -->
                                </div>
                            </div>
                        </div>
                        <!-- PVP Ring (Left) Selection Section -->
                        <div class="form-group" id="ring-left-section"
                            style="background: linear-gradient(145deg, #0a1a2a, #051a0d); border: 1px solid rgba(0, 188, 212, 0.3);">
                            <label class="form-label"><strong>üíç PvP Ring (Left)</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your Left Ring</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_ring_left }}
                                {{ attributes_form.pvp_ring_left_enchant }}
                            </div>

                            <div class="ring-grid" id="ring-left-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="ring-left-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(0, 188, 212, 0.2);">
                                <label class="form-label" style="color: #80DEEA; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-ring-left-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="ring-left-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                </div>
                            </div>
                        </div>

                        <!-- PVP Ring (Right) Selection Section -->
                        <div class="form-group" id="ring-right-section"
                            style="background: linear-gradient(145deg, #0a1a2a, #051a0d); border: 1px solid rgba(0, 188, 212, 0.3);">
                            <label class="form-label"><strong>üíç PvP Ring (Right)</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your Right Ring</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_ring_right }}
                                {{ attributes_form.pvp_ring_right_enchant }}
                            </div>

                            <div class="ring-grid" id="ring-right-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="ring-right-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(0, 188, 212, 0.2);">
                                <label class="form-label" style="color: #80DEEA; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-ring-right-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="ring-right-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                </div>
                            </div>
                        </div>


                        <!-- üõ°Ô∏è PvP Sigil Selection Section -->
                        <div class="form-group" id="sigil-section"
                            style="background: linear-gradient(145deg, #1a2a3a, #0d151d); border: 1px solid rgba(96, 125, 139, 0.3);">
                            <label class="form-label"><strong>üõ°Ô∏è PvP Sigil</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your üõ°Ô∏è Sigil</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_sigil }}
                                {{ attributes_form.pvp_sigil_enchant }}
                            </div>

                            <div class="sigil-grid" id="sigil-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="sigil-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(96, 125, 139, 0.2);">
                                <label class="form-label" style="color: #607D8B; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-sigil-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="sigil-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                            </div>
                        </div>

                        <!-- ü™ñ PvP Helmet Selection Section -->
                        <div class="form-group" id="helmet-section"
                            style="background: linear-gradient(145deg, #3a2a1a, #1d150d); border: 1px solid rgba(121, 85, 72, 0.3);">
                            <label class="form-label"><strong>ü™ñ PvP Helmet</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your ü™ñ Helmet</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_helmet }}
                                {{ attributes_form.pvp_helmet_enchant }}
                            </div>

                            <div class="helmet-grid" id="helmet-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="helmet-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(121, 85, 72, 0.2);">
                                <label class="form-label" style="color: #795548; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-helmet-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="helmet-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                            </div>
                        </div>

                        <!-- üëï PvP Armor (Top/Full) Selection Section -->
                        <div class="form-group" id="top_armor-section"
                            style="background: linear-gradient(145deg, #2a2a2a, #151515); border: 1px solid rgba(158, 158, 158, 0.3);">
                            <label class="form-label"><strong>üëï PvP Armor (Top/Full)</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your üëï Armor
                                (Top/Full)</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_top_armor }}
                                {{ attributes_form.pvp_top_armor_enchant }}
                            </div>

                            <div class="top_armor-grid" id="top_armor-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="top_armor-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(158, 158, 158, 0.2);">
                                <label class="form-label" style="color: #9E9E9E; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-top_armor-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="top_armor-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                </div>
                            </div>
                        </div>

                        <!-- üß§ PvP Gloves Selection Section -->
                        <div class="form-group" id="gloves-section"
                            style="background: linear-gradient(145deg, #3a1a0a, #1d0d05); border: 1px solid rgba(255, 87, 34, 0.3);">
                            <label class="form-label"><strong>üß§ PvP Gloves</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your üß§ Gloves</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_gloves }}
                                {{ attributes_form.pvp_gloves_enchant }}
                            </div>

                            <div class="gloves-grid" id="gloves-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="gloves-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255, 87, 34, 0.2);">
                                <label class="form-label" style="color: #FF5722; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-gloves-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="gloves-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                            </div>
                        </div>

                        <!-- üë¢ PvP Boots Selection Section -->
                        <div class="form-group" id="boots-section"
                            style="background: linear-gradient(145deg, #1a3a0a, #0d1d05); border: 1px solid rgba(139, 195, 74, 0.3);">
                            <label class="form-label"><strong>üë¢ PvP Boots</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your üë¢ Boots</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_boots }}
                                {{ attributes_form.pvp_boots_enchant }}
                            </div>

                            <div class="boots-grid" id="boots-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="boots-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(139, 195, 74, 0.2);">
                                <label class="form-label" style="color: #8BC34A; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-boots-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="boots-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                            </div>
                        </div>

                        <!-- üëñ PvP Gaiters (Pants) Selection Section -->
                        <div class="form-group" id="gaiters-section"
                            style="background: linear-gradient(145deg, #0a1a3a, #050d1d); border: 1px solid rgba(63, 81, 181, 0.3);">
                            <label class="form-label"><strong>üëñ PvP Gaiters (Pants)</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your üëñ Gaiters
                                (Pants)</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_gaiters }}
                                {{ attributes_form.pvp_gaiters_enchant }}
                            </div>

                            <div class="gaiters-grid" id="gaiters-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="gaiters-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(63, 81, 181, 0.2);">
                                <label class="form-label" style="color: #3F51B5; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-gaiters-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="gaiters-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                            </div>
                        </div>

                        <!-- üß• PvP Cloak Selection Section -->
                        <div class="form-group" id="cloak-section"
                            style="background: linear-gradient(145deg, #3a3a0a, #1d1d05); border: 1px solid rgba(255, 235, 59, 0.3);">
                            <label class="form-label"><strong>üß• PvP Cloak</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your üß• Cloak</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_cloak }}
                                {{ attributes_form.pvp_cloak_enchant }}
                            </div>

                            <div class="cloak-grid" id="cloak-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="cloak-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255, 235, 59, 0.2);">
                                <label class="form-label" style="color: #FFEB3B; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-cloak-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="cloak-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                            </div>
                        </div>


                        <!-- üëï PvP T-Shirt Selection Section -->
                        <div class="form-group" id="tshirt-section"
                            style="background: linear-gradient(145deg, #1a3a2a, #0d1d15); border: 1px solid rgba(76, 175, 80, 0.3);">
                            <label class="form-label"><strong>üëï PvP T-Shirt</strong></label>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">Select your üëï T-Shirt</p>

                            <div style="display: none;">
                                {{ attributes_form.pvp_tshirt }}
                                {{ attributes_form.pvp_tshirt_enchant }}
                            </div>

                            <div class="tshirt-grid" id="tshirt-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;">
                            </div>

                            <div id="tshirt-enchant-section"
                                style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(76, 175, 80, 0.2);">
                                <label class="form-label" style="color: #4CAF50; margin-bottom: 10px;">
                                    <strong>‚ú® Enchant Level</strong>
                                    <span id="selected-tshirt-name"
                                        style="color: #ccc; font-weight: normal; margin-left: 8px;"></span>
                                </label>
                                <div id="tshirt-enchant-grid" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                            </div>
                        </div>


                        <!-- Skills Section -->
                        <div class="form-group" id="skills-section">
                            <label class="form-label">
                                <strong>What are your skills?</strong>
                                <span id="current-class-skills-label" style="color:#FFA000; margin-left:10px;">Select a class first</span>
                            </label>
                            
                            {{ attributes_form.unlocked_skills }} <!-- hidden input -->

                            <!-- Skills Container where JS will render the Myth/Legend/Hero grids -->
                            <div id="dynamic-skills-container" style="display: flex; flex-direction: column; gap: 20px; margin-top: 20px;">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-buttons">
            <button type="submit" class="btn btn-primary">
                {% if is_edit %}
                Save Changes
                {% else %}
                Create Character
                {% endif %}
            </button>
            <a href="{% if is_edit %}{% url 'character-profile' character_form.instance.pk %}{% else %}{% url 'character-list' %}{% endif %}"
                class="btn btn-secondary">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
    // === VALIDASI MAX LIMIT ===
    const maxLimitFields = {
        'id_soulshot_level': 13, 
        'id_valor_level': 13, 
        'id_stat_guardian': 13, 
        'id_stat_conquer': 13,
        'id_aster_erafone': 30
    };

    const fieldNames = {
        'id_soulshot_level': 'Soulshot Level',
        'id_valor_level': 'Valor Level',
        'id_stat_guardian': 'Guardian',
        'id_stat_conquer': 'Conquer',
        'id_aster_erafone': 'Aster (Erafone)'
    };

    function showPopup(message) {
        const popup = document.getElementById('customPopup');
        const popupMessage = document.getElementById('popupMessage');
        popupMessage.textContent = message;
        popup.classList.add('show');
    }

    function closePopup() {
        const popup = document.getElementById('customPopup');
        popup.classList.remove('show');
    }

    function validateMaxValue(input) {
        const maxVal = maxLimitFields[input.id];
        const value = parseInt(input.value);
        if (value > maxVal) {
            const fieldName = fieldNames[input.id] || input.name;
            showPopup(fieldName + ' tidak boleh lebih dari ' + maxVal + '! Nilai akan disesuaikan ke ' + maxVal + '.');
            input.value = maxVal;
            setTimeout(function () {
                input.focus();
            }, 400);
        }
    }

    Object.keys(maxLimitFields).forEach(function (fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('change', function () {
                validateMaxValue(this);
            });
            field.addEventListener('blur', function () {
                validateMaxValue(this);
            });
        }
    });

    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', function () {
            const tabId = this.getAttribute('data-tab');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(tabId + '-tab').classList.add('active');
        });
    });

    // === WEAPON FILTERING BY CLASS ===
    const classToWeaponType = {{ class_to_weapon_type| safe }};
    const weaponImages = {{ weapon_images| safe }};
    const weaponSelect = document.getElementById('id_weapon');
    const weaponEnchantInput = document.getElementById('id_weapon_enchant');
    const weaponGrid = document.getElementById('weapon-grid');
    const noWeaponsMsg = document.getElementById('no-weapons-msg');
    const classSelect = document.getElementById('id_character_class');
    const enchantSection = document.getElementById('enchant-section');
    const enchantGrid = document.getElementById('enchant-grid');
    const selectedWeaponNameSpan = document.getElementById('selected-weapon-name');

    function getWeaponImageUrl(weaponValue) {
        const imgPath = weaponImages[weaponValue];
        if (imgPath) {
            return '/media/' + imgPath;
        }
        return null;
    }

    function buildEnchantGrid(weaponName) {
        if (!enchantSection || !enchantGrid || !weaponEnchantInput) return;

        if (!weaponName) {
            enchantSection.style.display = 'none';
            return;
        }

        enchantSection.style.display = 'block';
        selectedWeaponNameSpan.textContent = '‚Äî ' + weaponName;
        enchantGrid.innerHTML = '';

        const currentEnchant = parseInt(weaponEnchantInput.value) || 0;

        for (let i = 0; i <= 11; i++) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'enchant-btn' + (currentEnchant === i ? ' selected' : '');
            btn.textContent = i === 0 ? '+0' : '+' + i;
            btn.dataset.level = i;

            btn.addEventListener('click', function () {
                weaponEnchantInput.value = i;
                document.querySelectorAll('.enchant-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
            });

            enchantGrid.appendChild(btn);
        }
    }

    function selectWeapon(weaponValue, weaponName) {
        weaponSelect.value = weaponValue;
        document.querySelectorAll('.weapon-card').forEach(c => c.classList.remove('selected'));
        // Find and highlight the clicked card
        const cards = document.querySelectorAll('.weapon-card');
        cards.forEach(c => {
            const radio = c.querySelector('input[name="weapon_visual"]');
            if (radio && radio.value === weaponValue) {
                c.classList.add('selected');
            }
        });

        // Show/hide enchant section
        if (weaponValue) {
            buildEnchantGrid(weaponName);
        } else {
            // No weapon selected - reset enchant
            if (weaponEnchantInput) weaponEnchantInput.value = 0;
            if (enchantSection) enchantSection.style.display = 'none';
        }
    }

    function buildWeaponGrid() {
        if (!classSelect || !weaponSelect || !weaponGrid) return;

        const selectedClass = classSelect.value;
        const weaponType = classToWeaponType[selectedClass] || '';
        const currentWeaponValue = weaponSelect.value;

        weaponGrid.innerHTML = '';
        let count = 0;

        // Add "No weapon" option
        const noWeaponCard = document.createElement('label');
        noWeaponCard.className = 'weapon-card' + (currentWeaponValue === '' ? ' selected' : '');
        noWeaponCard.innerHTML = `
            <input type="radio" name="weapon_visual" value="" ${currentWeaponValue === '' ? 'checked' : ''} style="display:none;">
            <div class="weapon-card-inner">
                <div class="weapon-card-img" style="display:flex;align-items:center;justify-content:center;font-size:2rem;color:#666;">‚úï</div>
                <div class="weapon-card-name">No weapon</div>
            </div>
        `;
        noWeaponCard.addEventListener('click', function () {
            selectWeapon('', '');
        });
        weaponGrid.appendChild(noWeaponCard);

        // Filter and show weapons for selected class
        for (let i = 0; i < weaponSelect.options.length; i++) {
            const opt = weaponSelect.options[i];
            if (!opt.value || !opt.value.includes('|')) continue;

            const [wType, wName] = opt.value.split('|', 2);
            if (weaponType && wType !== weaponType) continue;

            count++;
            const imgUrl = getWeaponImageUrl(opt.value);
            const isSelected = currentWeaponValue === opt.value;

            const card = document.createElement('label');
            card.className = 'weapon-card' + (isSelected ? ' selected' : '');
            card.dataset.weaponType = wType;
            card.innerHTML = `
                <input type="radio" name="weapon_visual" value="${opt.value}" ${isSelected ? 'checked' : ''} style="display:none;">
                <div class="weapon-card-inner">
                    ${imgUrl ? `<img src="${imgUrl}" alt="${wName}" class="weapon-card-img" onerror="this.style.display='none'">` : '<div class="weapon-card-img" style="display:flex;align-items:center;justify-content:center;color:#666;">‚öîÔ∏è</div>'}
                    <div class="weapon-card-name">${wName}</div>
                </div>
            `;
            card.addEventListener('click', function () {
                selectWeapon(opt.value, wName);
            });
            weaponGrid.appendChild(card);
        }

        if (count === 0 && !weaponType) {
            noWeaponsMsg.style.display = 'block';
        } else {
            noWeaponsMsg.style.display = 'none';
        }

        // If a weapon is already selected, show enchant grid
        if (currentWeaponValue && currentWeaponValue.includes('|')) {
            const [, currentWName] = currentWeaponValue.split('|', 2);
            buildEnchantGrid(currentWName);
        } else {
            if (enchantSection) enchantSection.style.display = 'none';
        }
    }

    // Listen for class changes
    if (classSelect) {
        classSelect.addEventListener('change', function () {
            // Reset weapon selection when class changes
            if (weaponSelect) weaponSelect.value = '';
            if (weaponEnchantInput) weaponEnchantInput.value = 0;
            buildWeaponGrid();
        });
    }

    // Build initial weapon grid
    buildWeaponGrid();

    // === PVP BELT SELECTION ===
    const beltSelect = document.getElementById('id_pvp_belt');
    const beltEnchantInput = document.getElementById('id_pvp_belt_enchant');
    const beltGrid = document.getElementById('belt-grid');
    const beltEnchantSection = document.getElementById('belt-enchant-section');
    const beltEnchantGrid = document.getElementById('belt-enchant-grid');
    const selectedBeltNameSpan = document.getElementById('selected-belt-name');

    function buildBeltEnchantGrid(beltName) {
        if (!beltEnchantSection || !beltEnchantGrid || !beltEnchantInput) return;

        if (!beltName) {
            beltEnchantSection.style.display = 'none';
            return;
        }

        beltEnchantSection.style.display = 'block';
        selectedBeltNameSpan.textContent = '‚Äî ' + beltName;
        beltEnchantGrid.innerHTML = '';

        const currentEnchant = parseInt(beltEnchantInput.value) || 0;

        for (let i = 0; i <= 11; i++) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'enchant-btn belt-enchant' + (currentEnchant === i ? ' selected' : '');
            btn.textContent = i === 0 ? '+0' : '+' + i;
            btn.dataset.level = i;

            btn.addEventListener('click', function () {
                beltEnchantInput.value = i;
                document.querySelectorAll('.belt-enchant').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
            });

            beltEnchantGrid.appendChild(btn);
        }
    }

    function selectBelt(beltValue, beltName) {
        if (beltSelect) beltSelect.value = beltValue;
        document.querySelectorAll('.belt-card').forEach(c => c.classList.remove('selected'));
        const cards = document.querySelectorAll('.belt-card');
        cards.forEach(c => {
            const radio = c.querySelector('input[name="belt_visual"]');
            if (radio && radio.value === beltValue) {
                c.classList.add('selected');
            }
        });

        if (beltValue) {
            buildBeltEnchantGrid(beltName);
        } else {
            if (beltEnchantInput) beltEnchantInput.value = 0;
            if (beltEnchantSection) beltEnchantSection.style.display = 'none';
        }
    }

    function buildBeltGrid() {
        if (!beltSelect || !beltGrid) return;

        const currentBeltValue = beltSelect.value;
        beltGrid.innerHTML = '';

        // Add "No belt" option
        const noBeltCard = document.createElement('label');
        noBeltCard.className = 'belt-card weapon-card' + (currentBeltValue === '' ? ' selected' : '');
        noBeltCard.innerHTML = `
            <input type="radio" name="belt_visual" value="" ${currentBeltValue === '' ? 'checked' : ''} style="display:none;">
            <div class="weapon-card-inner">
                <div class="weapon-card-img" style="display:flex;align-items:center;justify-content:center;font-size:2rem;color:#666;">‚úï</div>
                <div class="weapon-card-name">No belt</div>
            </div>
        `;
        noBeltCard.addEventListener('click', function () {
            selectBelt('', '');
        });
        beltGrid.appendChild(noBeltCard);

        // Show all belt options
        for (let i = 0; i < beltSelect.options.length; i++) {
            const opt = beltSelect.options[i];
            if (!opt.value) continue;

            const beltName = opt.value;
            const isSelected = currentBeltValue === opt.value;

            // Try to find image from static choices
            const imgName = getBeltImage(beltName);

            const card = document.createElement('label');
            card.className = 'belt-card weapon-card' + (isSelected ? ' selected' : '');
            card.innerHTML = `
                <input type="radio" name="belt_visual" value="${opt.value}" ${isSelected ? 'checked' : ''} style="display:none;">
                <div class="weapon-card-inner">
                    ${imgName ? `<img src="/static/items/images/choices/${imgName}" alt="${beltName}" class="weapon-card-img" onerror="this.style.display='none'">` : '<div class="weapon-card-img" style="display:flex;align-items:center;justify-content:center;color:#666;">üõ°Ô∏è</div>'}
                    <div class="weapon-card-name">${beltName}</div>
                </div>
            `;
            card.addEventListener('click', function () {
                selectBelt(opt.value, beltName);
            });
            beltGrid.appendChild(card);
        }

        // If belt already selected, show enchant grid
        if (currentBeltValue) {
            buildBeltEnchantGrid(currentBeltValue);
        } else {
            if (beltEnchantSection) beltEnchantSection.style.display = 'none';
        }
    }

    // Belt image mapping (based on existing static images)
    function getBeltImage(beltName) {
        const beltImages = {
            'Blue': 'Icon_ACC_Belt_G3_004.png',
            "Ekimus' Belt": 'Icon_ACC_Belt_G3_003.png',
            'Dragon Belt': 'Icon_ACC_Belt_G3_001.png',
            "Tiat's Belt": 'Icon_ACC_Belt_G3_002.png',
            "Eratone's Belt": 'Icon_ACC_Belt_G3_003_UHLGN0X.png',
            "Lord's Authority": 'Icon_ACC_Belt_G2_001.png',
            "Maphr's Belt": 'Icon_ACC_Belt_G2_002.png',
        };
        return beltImages[beltName] || null;
    }

    // Build initial belt grid
    buildBeltGrid();

    // === GENERIC EQUIPMENT GRID BUILDER (for rings and future items) ===
    function getRingImage(ringName) {
        const ringImages = {
            'Ring of Blessing': 'Icon_ACC_Ring_G4_010.png',
            "Lilith's Ring": 'Icon_ACC_Ring_G3_003.png',
            "Anakeem's Ring": 'Icon_ACC_Ring_G3_003.png',
            "Baium's Ring": 'Icon_ACC_Ring_G3_001.png',
            "Vereth's Ring": 'Icon_ACC_Ring_G3_006.png',
            'Core Ring': 'Icon_ACC_Ring_G3_005.png',
            "Queen Ant's Ring": 'Icon_ACC_Ring_G3_004.png',
            'Ring of Passion': 'Icon_ACC_Ring_G3_008.png',
            'Majestic Ring': 'Icon_ACC_Ring_G3_001.png',
            "Forgotten Hero's Ring": 'Icon_ACC_Ring_G3_009.png',
            "Desperion's Ring": 'Icon_ACC_Ring_G2_001.png',
        };
        return ringImages[ringName] || null;
    }

    function buildEquipGrid(config) {
        const { selectEl, enchantInput, gridEl, enchantSection, enchantGridEl, nameSpan, getImageFn, cardClass, enchantClass, radioName } = config;
        if (!selectEl || !gridEl) return;

        const currentValue = selectEl.value;
        gridEl.innerHTML = '';

        // "No item" option
        const noCard = document.createElement('label');
        noCard.className = cardClass + ' weapon-card' + (currentValue === '' ? ' selected' : '');
        noCard.innerHTML = `
            <input type="radio" name="${radioName}" value="" ${currentValue === '' ? 'checked' : ''} style="display:none;">
            <div class="weapon-card-inner">
                <div class="weapon-card-img" style="display:flex;align-items:center;justify-content:center;font-size:2rem;color:#666;">‚úï</div>
                <div class="weapon-card-name">None</div>
            </div>
        `;
        noCard.addEventListener('click', function () {
            selectEl.value = '';
            document.querySelectorAll('.' + cardClass).forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            if (enchantInput) enchantInput.value = 0;
            if (enchantSection) enchantSection.style.display = 'none';
        });
        gridEl.appendChild(noCard);

        for (let i = 0; i < selectEl.options.length; i++) {
            const opt = selectEl.options[i];
            if (!opt.value) continue;

            const itemName = opt.value;
            const isSelected = currentValue === opt.value;
            const imgName = getImageFn(itemName);

            const card = document.createElement('label');
            card.className = cardClass + ' weapon-card' + (isSelected ? ' selected' : '');
            card.innerHTML = `
                <input type="radio" name="${radioName}" value="${opt.value}" ${isSelected ? 'checked' : ''} style="display:none;">
                <div class="weapon-card-inner">
                    ${imgName ? `<img src="/static/items/images/choices/${imgName}" alt="${itemName}" class="weapon-card-img" onerror="this.style.display='none'">` : '<div class="weapon-card-img" style="display:flex;align-items:center;justify-content:center;color:#666;">üíç</div>'}
                    <div class="weapon-card-name">${itemName}</div>
                </div>
            `;
            card.addEventListener('click', function () {
                selectEl.value = opt.value;
                document.querySelectorAll('.' + cardClass).forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                if (itemName && enchantSection) {
                    buildEquipEnchant(enchantInput, enchantSection, enchantGridEl, nameSpan, itemName, enchantClass);
                }
            });
            gridEl.appendChild(card);
        }

        if (currentValue && enchantSection) {
            buildEquipEnchant(enchantInput, enchantSection, enchantGridEl, nameSpan, currentValue, enchantClass);
        } else if (enchantSection) {
            enchantSection.style.display = 'none';
        }
    }

    function buildEquipEnchant(enchantInput, enchantSection, enchantGridEl, nameSpan, itemName, enchantClass) {
        if (!enchantSection || !enchantGridEl || !enchantInput) return;
        enchantSection.style.display = 'block';
        if (nameSpan) nameSpan.textContent = '‚Äî ' + itemName;
        enchantGridEl.innerHTML = '';

        const currentEnchant = parseInt(enchantInput.value) || 0;
        for (let i = 0; i <= 11; i++) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'enchant-btn ' + enchantClass + (currentEnchant === i ? ' selected' : '');
            btn.textContent = i === 0 ? '+0' : '+' + i;
            btn.addEventListener('click', function () {
                enchantInput.value = i;
                document.querySelectorAll('.' + enchantClass).forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
            });
            enchantGridEl.appendChild(btn);
        }
    }

    // === PVP RING LEFT ===
    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_ring_left'),
        enchantInput: document.getElementById('id_pvp_ring_left_enchant'),
        gridEl: document.getElementById('ring-left-grid'),
        enchantSection: document.getElementById('ring-left-enchant-section'),
        enchantGridEl: document.getElementById('ring-left-enchant-grid'),
        nameSpan: document.getElementById('selected-ring-left-name'),
        getImageFn: getRingImage,
        cardClass: 'ring-left-card',
        enchantClass: 'ring-left-enchant',
        radioName: 'ring_left_visual'
    });

    // === PVP RING RIGHT ===
    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_ring_right'),
        enchantInput: document.getElementById('id_pvp_ring_right_enchant'),
        gridEl: document.getElementById('ring-right-grid'),
        enchantSection: document.getElementById('ring-right-enchant-section'),
        enchantGridEl: document.getElementById('ring-right-enchant-grid'),
        nameSpan: document.getElementById('selected-ring-right-name'),
        getImageFn: getRingImage,
        cardClass: 'ring-right-card',
        enchantClass: 'ring-right-enchant',
        radioName: 'ring_right_visual'
    });

    // === PVP NECKLACE ===
    function getNecklaceImage(itemName) {
        const images = {
            "Blue necklace": "Icon_ACC_Necklace_G4_007.png",
            "Necklace of Immortality": "Icon_ACC_Necklace_G3_001.png",
            "Lilith's Soul Necklace": "Icon_ACC_Necklace_G3_002.png",
            "Anakeem's Soul Necklace": "Icon_ACC_Necklace_G3_002.png",
            "Baium's Necklace": "Icon_ACC_Necklace_G3_001.png",
            "Zaken's Necklace": "Icon_ACC_Necklace_G3_004.png",
            "Orfen's Necklace": "Icon_ACC_Necklace_G2_002.png",
            "Majestic Necklace": "Icon_ACC_Necklace_G3_001.png",
            "Apella Necklace": "Icon_ACC_Necklace_G3_001.png",
            "Valakas' Necklace": "Icon_ACC_Necklace_G3_003.png",
            "Antharas Necklace": "Icon_ACC_Necklace_G3_006.png",
            "Lindvior's Necklace": "Icon_ACC_Necklace_G3_006.png",
            "Archmage Necklace": "Icon_ACC_Necklace_G3_001.png",
        };
        return images[itemName] || null;
    }

    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_necklace'),
        enchantInput: document.getElementById('id_pvp_necklace_enchant'),
        gridEl: document.getElementById('necklace-grid'),
        enchantSection: document.getElementById('necklace-enchant-section'),
        enchantGridEl: document.getElementById('necklace-enchant-grid'),
        nameSpan: document.getElementById('selected-necklace-name'),
        getImageFn: getNecklaceImage,
        cardClass: 'necklace-card',
        enchantClass: 'necklace-enchant',
        radioName: 'necklace_visual'
    });

    // === PVP SIGIL ===
    function getSigilImage(itemName) {
        const images = {
            "Arcana Sigil": "armor_sigil_Arcana_Sigil.png",
            "Blood Crystal": "armor_sigil_Blood_Crystal.png",
            "Cruma's Shell": "armor_sigil_Cruma's_Shell.png",
            "Crystal of Oblivion": "armor_sigil_Crystal_of_Oblivion.png",
            "Draconic Sigil": "armor_sigil_Draconic_Sigil.png",
            "Dream Sigil": "armor_sigil_Dream_Sigil.png",
            "Eldarach": "armor_sigil_Eldarach.png",
            "Holy Sigil": "armor_sigil_Holy_Sigil.png",
            "Parody Sigil": "armor_sigil_Parody_Sigil.png",
            "Sally Horden's Horn": "armor_sigil_Sally_Horden's_Horn.png",
            "Sniper Sigil": "armor_sigil_Sniper_Sigil.png",
            "Susceptor's Heart": "armor_sigil_Susceptor's_Heart.png",
            "The Sigil of the Fallen Angel": "armor_sigil_The_Sigil_of_the_Fallen_Angel.png",
            "The Sigil of Karma": "armor_sigil_The_sigil_of_karma.png",
            "Tier of Darkness": "armor_sigil_Tier_of_Darkness.png"
        };
        return images[itemName] || null;
    }

    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_sigil'),
        enchantInput: document.getElementById('id_pvp_sigil_enchant'),
        gridEl: document.getElementById('sigil-grid'),
        enchantSection: document.getElementById('sigil-enchant-section'),
        enchantGridEl: document.getElementById('sigil-enchant-grid'),
        nameSpan: document.getElementById('selected-sigil-name'),
        getImageFn: getSigilImage,
        cardClass: 'sigil-card',
        enchantClass: 'sigil-enchant',
        radioName: 'sigil_visual'
    });

    // === PVP HELMET ===
    function getHelmetImage(itemName) {
        const images = {
            "Ancient Elven Helmet": "armor_helmet_Ancient_Elven_Helmet.png",
            "Crown of the World Tree": "armor_helmet_Crown_of_the_World_Tree.png",
            "Dark Crystal Helmet": "armor_helmet_Dark_Crystal_Helmet.png",
            "Devil's Helmet": "armor_helmet_Devil's_Helmet.png",
            "Draconic Leather Helmet": "armor_helmet_Draconic_Leather_Helmet.png",
            "Helmet of the Fallen Angel": "armor_helmet_Helmet_of_the_Fallen_Angel.png",
            "Hildegrim": "armor_helmet_Hildegrim.png",
            "Imperial Crusader Helmet": "armor_helmet_Imperial_Crusader_Helmet.png",
            "Majestic Circlet": "armor_helmet_Majestic_Circlet.png",
            "Major Arcana Circlet": "armor_helmet_Major_Arcana_Circlet.png",
            "Medusa's Helmet": "armor_helmet_Medusa's_Helmet.png",
            "Nebit's Helmet": "armor_helmet_Nebit's_Helmet.png",
            "Nightmare Helmet": "armor_helmet_Nightmare_Helmet.png",
            "Pauline's Helmet": "armor_helmet_Pauline's_Helmet.png",
            "Tersi's Circlet": "armor_helmet_Tersi's_Circlet.png"
        };
        return images[itemName] || null;
    }

    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_helmet'),
        enchantInput: document.getElementById('id_pvp_helmet_enchant'),
        gridEl: document.getElementById('helmet-grid'),
        enchantSection: document.getElementById('helmet-enchant-section'),
        enchantGridEl: document.getElementById('helmet-enchant-grid'),
        nameSpan: document.getElementById('selected-helmet-name'),
        getImageFn: getHelmetImage,
        cardClass: 'helmet-card',
        enchantClass: 'helmet-enchant',
        radioName: 'helmet_visual'
    });

    // === PVP TOP ARMOR ===
    function getTopArmorImage(itemName) {
        const images = {
            "Absolute Tunic": "armor_armor_Absolute_Tunic.png",
            "Apella's Armor": "armor_armor_Apella's_Armor.png",
            "Breastplate of the Fallen Angel": "armor_armor_Breastplate_of_the_Fallen_Angel.png",
            "Breastplate of the Forgotten Hero": "armor_armor_Breastplate_of_the_Forgotten_Hero.png",
            "Dark Crystal Breastplate": "armor_armor_Dark_Crystal_Breastplate.png",
            "Devil's Armor": "armor_armor_Devil's_Armor.png",
            "Draconic Leather Armor": "armor_armor_Draconic_Leather_Armor.png",
            "Imperial Crusader Breastplate": "armor_armor_Imperial_Crusader_Breastplate.png",
            "Majestic Robe": "armor_armor_Majestic_Robe.png",
            "Major Arcana Robe": "armor_armor_Major_Arcana_Robe.png",
            "Nebit's Armor": "armor_armor_Nebit's_Armor.png",
            "Nightmare Armor": "armor_armor_Nightmare_Armor.png",
            "Polyne's Breastplate": "armor_armor_Polyne's_Breastplate.png",
            "Saban's Robe": "armor_armor_Saban's_Robe.png",
            "Tersi's Robe": "armor_armor_Tersi's_Robe.png"
        };
        return images[itemName] || null;
    }

    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_top_armor'),
        enchantInput: document.getElementById('id_pvp_top_armor_enchant'),
        gridEl: document.getElementById('top_armor-grid'),
        enchantSection: document.getElementById('top_armor-enchant-section'),
        enchantGridEl: document.getElementById('top_armor-enchant-grid'),
        nameSpan: document.getElementById('selected-top_armor-name'),
        getImageFn: getTopArmorImage,
        cardClass: 'top_armor-card',
        enchantClass: 'top_armor-enchant',
        radioName: 'top_armor_visual'
    });

    // === PVP GLOVES ===
    function getGlovesImage(itemName) {
        const images = {
            "Ancient Elven Gauntlets": "armor_gloves_Ancient_Elven_Gauntlets.png",
            "Dark Crystal Globe": "armor_gloves_Dark_Crystal_Globe.png",
            "Devil's Gauntlet": "armor_gloves_Devil's_Gauntlet.png",
            "Draconic Leather Gloves": "armor_gloves_Draconic_Leather_Gloves.png",
            "Fallen Angel's Gloves": "armor_gloves_Fallen_Angel's_Gloves.png",
            "Globe of the Forgotten Hero": "armor_gloves_Globe_of_the_Forgotten_Hero.png",
            "Gloves of Blessing": "armor_gloves_Gloves_of_Blessing.png",
            "Guardian of Vision": "armor_gloves_Guardian_of_Vision.png",
            "Jarngreifr": "armor_gloves_Jarngreifr.png",
            "Majestic Gloves": "armor_gloves_Majestic_Gloves.png",
            "Nebit's Globe": "armor_gloves_Nebit's_Globe.png",
            "Nightmare Gauntlet": "armor_gloves_Nightmare_Gauntlet.png",
            "Paagrio's Flame": "armor_gloves_Paagrio's_Flame.png",
            "Pauline's Gauntlet": "armor_gloves_Pauline's_Gauntlet.png",
            "Tersi's Gloves": "armor_gloves_Tersi's_Gloves.png"
        };
        return images[itemName] || null;
    }

    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_gloves'),
        enchantInput: document.getElementById('id_pvp_gloves_enchant'),
        gridEl: document.getElementById('gloves-grid'),
        enchantSection: document.getElementById('gloves-enchant-section'),
        enchantGridEl: document.getElementById('gloves-enchant-grid'),
        nameSpan: document.getElementById('selected-gloves-name'),
        getImageFn: getGlovesImage,
        cardClass: 'gloves-card',
        enchantClass: 'gloves-enchant',
        radioName: 'gloves_visual'
    });

    // === PVP BOOTS ===
    function getBootsImage(itemName) {
        const images = {
            "Ancient Elven Boots": "armor_shoes_Ancient_Elven_Boots.png",
            "Boots of Eternal Life": "armor_shoes_Boots_of_Eternal_Life.png",
            "Boots of the Forgotten Hero": "armor_shoes_Boots_of_the_Forgotten_Hero.png",
            "Calie's Boots": "armor_shoes_Calie's_boots.png",
            "Dark Crystal Boots": "armor_shoes_Dark_Crystal_Boots.png",
            "Devil's Boots": "armor_shoes_Devil's_Boots.png",
            "Draconic Leather Boots": "armor_shoes_Draconic_Leather_Boots.png",
            "Fallen Angel's Boots": "armor_shoes_Fallen_Angel's_Boots.png",
            "Majestic Boots": "armor_shoes_Majestic_Boots.png",
            "Nebit's Boots": "armor_shoes_Nebit's_Boots.png",
            "Nightmare Boots": "armor_shoes_Nightmare_Boots.png",
            "Pauline's Boots": "armor_shoes_Pauline's_boots.png",
            "Reaper's Boots": "armor_shoes_Reaper's_Boots.png",
            "Saiha's Wind": "armor_shoes_Saiha's_Wind.png",
            "Tersi's Boots": "armor_shoes_Tersi's_boots.png"
        };
        return images[itemName] || null;
    }

    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_boots'),
        enchantInput: document.getElementById('id_pvp_boots_enchant'),
        gridEl: document.getElementById('boots-grid'),
        enchantSection: document.getElementById('boots-enchant-section'),
        enchantGridEl: document.getElementById('boots-enchant-grid'),
        nameSpan: document.getElementById('selected-boots-name'),
        getImageFn: getBootsImage,
        cardClass: 'boots-card',
        enchantClass: 'boots-enchant',
        radioName: 'boots_visual'
    });

    // === PVP GAITERS ===
    function getGaitersImage(itemName) {
        const images = {
            "Basil's Shell": "armor_bottoms_Basil's_shell.png",
            "Blood Greaves": "armor_bottoms_Blood_Greaves.png",
            "Blue Wolf's Leggings": "armor_bottoms_Blue_Wolf's_Leggings.png",
            "Breath of Silen": "armor_bottoms_Breath_of_Silen.png",
            "Crystal Gaiters": "armor_bottoms_Crystal_gaiters.png",
            "Devil's Pact": "armor_bottoms_Devil's_Pact.png",
            "Fallen Angel's Legguards": "armor_bottoms_Fallen_Angel's_Legguards.png",
            "Flame Greaves": "armor_bottoms_Flame_Greaves.png",
            "Forgotten Hero's Greaves": "armor_bottoms_Forgotten_Hero's_Greaves.png",
            "Full Plate Gaiters": "armor_bottoms_Full_plate_gaiters.png",
            "Ice Leggings": "armor_bottoms_Ice_Leggings.png",
            "Imperial Crusader Legguards": "armor_bottoms_Imperial_Crusader_Legguards.png",
            "Light's Greaves": "armor_bottoms_Light's_Greaves.png",
            "Patience Leggings": "armor_bottoms_Patience_Leggings.png",
            "Spirit's Greaves": "armor_bottoms_Spirit's_Greaves.png"
        };
        return images[itemName] || null;
    }

    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_gaiters'),
        enchantInput: document.getElementById('id_pvp_gaiters_enchant'),
        gridEl: document.getElementById('gaiters-grid'),
        enchantSection: document.getElementById('gaiters-enchant-section'),
        enchantGridEl: document.getElementById('gaiters-enchant-grid'),
        nameSpan: document.getElementById('selected-gaiters-name'),
        getImageFn: getGaitersImage,
        cardClass: 'gaiters-card',
        enchantClass: 'gaiters-enchant',
        radioName: 'gaiters_visual'
    });

    // === PVP CLOAK ===
    function getCloakImage(itemName) {
        const images = {
            "Aegis Cloak": "armor_cloak_Aegis_Cloak.png",
            "Cloak of Power": "armor_cloak_Cloak_of_Power.png",
            "Cloak of Silence": "armor_cloak_Cloak_of_Silence.png",
            "Cloak of Verdant Green": "armor_cloak_Cloak_of_Verdant_Green.png",
            "Cranbel's Cloak": "armor_cloak_Cranbel's_Cloak.png",
            "Dragon's Scales": "armor_cloak_Dragon's_Scales.png",
            "Freya's Cloak": "armor_cloak_Freya's_Cloak.png",
            "Jaqen's Cloak": "armor_cloak_Jaqen's_Cloak.png",
            "Mantle of the Holy Spirit": "armor_cloak_Mantle_of_the_Holy_Spirit.png",
            "Moonlight's Cloak": "armor_cloak_Moonlight's_Cloak.png",
            "Nebit's Cloak of Light": "armor_cloak_Nebit's_Cloak_of_Light.png",
            "Niarop's Cloak": "armor_cloak_Niarop's_Cloak.png",
            "Salamander's Cloak": "armor_cloak_Salamander's_Cloak.png",
            "Sally Hoden's Wings": "armor_cloak_Sally_Hoden's_Wings.png",
            "Queen Ant Wings": "armor_cloak_queen_ant_wings.png"
        };
        return images[itemName] || null;
    }

    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_cloak'),
        enchantInput: document.getElementById('id_pvp_cloak_enchant'),
        gridEl: document.getElementById('cloak-grid'),
        enchantSection: document.getElementById('cloak-enchant-section'),
        enchantGridEl: document.getElementById('cloak-enchant-grid'),
        nameSpan: document.getElementById('selected-cloak-name'),
        getImageFn: getCloakImage,
        cardClass: 'cloak-card',
        enchantClass: 'cloak-enchant',
        radioName: 'cloak_visual'
    });

    // === PVP T-SHIRT ===
    function getTshirtImage(itemName) {
        const images = {
            "Agility's Anonymous Shirt": "armor_tshirt_Agility's_anonymous_shirt.png",
            "Anonymous Shirt of Knowledge": "armor_tshirt_Anonymous_Shirt_of_Knowledge.png",
            "Anonymous Shirt of Strength": "armor_tshirt_Anonymous_shirt_of_strength.png",
            "Focus Shirt": "armor_tshirt_Focus_Shirt.png",
            "Mithril Shirt of Agility": "armor_tshirt_Mithril_Shirt_of_Agility.png",
            "Mithril Shirt of Knowledge": "armor_tshirt_Mithril_Shirt_of_Knowledge.png",
            "Mithril Shirt of Strength": "armor_tshirt_Mithril_Shirt_of_Strength.png",
            "Vigilante Shirt": "armor_tshirt_Vigilante_Shirt.png",
            "Warrior's T-shirt": "armor_tshirt_Warrior's_T-shirt.png"
        };
        return images[itemName] || null;
    }

    buildEquipGrid({
        selectEl: document.getElementById('id_pvp_tshirt'),
        enchantInput: document.getElementById('id_pvp_tshirt_enchant'),
        gridEl: document.getElementById('tshirt-grid'),
        enchantSection: document.getElementById('tshirt-enchant-section'),
        enchantGridEl: document.getElementById('tshirt-enchant-grid'),
        nameSpan: document.getElementById('selected-tshirt-name'),
        getImageFn: getTshirtImage,
        cardClass: 'tshirt-card',
        enchantClass: 'tshirt-enchant',
        radioName: 'tshirt_visual'
    });
    // === DYNAMIC CLASS SKILLS ===
    const classSkillsData = {{ class_skills_data|safe }};
    const skillsClassSelect = document.getElementById('id_character_class');
    const skillsContainer = document.getElementById('dynamic-skills-container');
    const skillsLabelInfo = document.getElementById('current-class-skills-label');
    const unlockedSkillsHidden = document.getElementById('unlocked_skills_hidden');

    function renderSkills() {
        const selectedClass = skillsClassSelect.value;
        skillsContainer.innerHTML = '';
        
        if (!selectedClass || !classSkillsData[selectedClass]) {
            skillsLabelInfo.textContent = 'Select a class to view skills';
            return;
        }

        skillsLabelInfo.textContent = 'for ' + selectedClass;
        const skillsObj = classSkillsData[selectedClass];

        // Parse existing skills
        let currentUnlocked = [];
        try {
            currentUnlocked = JSON.parse(unlockedSkillsHidden.value || '[]');
        } catch(e) {
            currentUnlocked = [];
        }

        const rarities = [
            { key: 'myth', title: 'Myth', color: '#B266FF', bg: 'rgba(178, 102, 255, 0.1)' },
            { key: 'legend', title: 'Legend', color: '#ff5c5c', bg: 'rgba(255, 92, 92, 0.1)' },
            { key: 'hero', title: 'Hero', color: '#4da6ff', bg: 'rgba(77, 166, 255, 0.1)' }
        ];

        rarities.forEach(r => {
            if(!skillsObj[r.key] || skillsObj[r.key].length === 0) return;

            const section = document.createElement('div');
            section.style.background = 'rgba(20, 20, 20, 0.6)';
            section.style.border = `1px solid ${r.color}`;
            section.style.borderRadius = '10px';
            section.style.padding = '15px';
            section.style.marginBottom = '10px';

            const title = document.createElement('h4');
            title.style.color = r.color;
            title.style.marginBottom = '15px';
            title.style.fontSize = '1.1rem';
            title.innerHTML = title.textContent = r.title;
            section.appendChild(title);

            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(180px, 1fr))';
            grid.style.gap = '10px';

            skillsObj[r.key].forEach(skill => {
                const isChecked = currentUnlocked.includes(skill);
                const label = document.createElement('label');
                label.className = 'checkbox-label' + (isChecked ? ' checked' : '');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '8px';
                label.style.cursor = 'pointer';
                label.style.padding = '8px';
                label.style.background = isChecked ? r.bg : 'rgba(0,0,0,0.3)';
                label.style.borderRadius = '6px';
                label.style.transition = 'all 0.2s';
                label.style.border = isChecked ? `1px solid ${r.color}` : '1px solid transparent';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = skill;
                input.checked = isChecked;
                input.style.accentColor = r.color;
                
                input.addEventListener('change', function() {
                    let unlocked = [];
                    try { unlocked = JSON.parse(unlockedSkillsHidden.value || '[]'); } catch(e) {}
                    
                    if(this.checked) {
                        if(!unlocked.includes(this.value)) unlocked.push(this.value);
                        label.style.background = r.bg;
                        label.style.border = `1px solid ${r.color}`;
                    } else {
                        unlocked = unlocked.filter(s => s !== this.value);
                        label.style.background = 'rgba(0,0,0,0.3)';
                        label.style.border = '1px solid transparent';
                    }
                    unlockedSkillsHidden.value = JSON.stringify(unlocked);
                });

                label.appendChild(input);
                label.appendChild(document.createTextNode(' ' + skill));
                grid.appendChild(label);
            });

            section.appendChild(grid);
            skillsContainer.appendChild(section);
        });
    }

    if (skillsClassSelect) {
        let lastSelectedClass = skillsClassSelect.value;
        skillsClassSelect.addEventListener('change', function() {
            if (this.value !== lastSelectedClass) {
                // Only clear unlocked skills if actually changing the class to something else
                unlockedSkillsHidden.value = '[]'; 
                lastSelectedClass = this.value;
            }
            renderSkills();
        });
    }

    // Initial render
    renderSkills();

    // === VISUAL ENHANCEMENT: Auto-clear '0' on focus ===
    document.addEventListener('DOMContentLoaded', function() {
        // Target numeric inputs in the form, specifically those in stat-card or general numeric inputs
        const statInputs = document.querySelectorAll('input[type="number"]');
        
        statInputs.forEach(input => {
            input.addEventListener('focus', function() {
                if (this.value === '0') {
                    this.value = '';
                }
            });
            
            input.addEventListener('blur', function() {
                if (this.value === '') {
                    this.value = '0';
                }
            });
        });
    });
</script>

<style>
    .weapon-card {
        cursor: pointer;
        border-radius: 12px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        background: rgba(30, 30, 30, 0.7);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .weapon-card:hover {
        border-color: rgba(255, 152, 0, 0.5);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(255, 152, 0, 0.2);
    }

    .weapon-card.selected {
        border-color: #FF9800;
        background: rgba(255, 152, 0, 0.15);
        box-shadow: 0 0 20px rgba(255, 152, 0, 0.3);
    }

    .weapon-card-inner {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px 8px;
        gap: 8px;
    }

    .weapon-card-img {
        width: 80px;
        height: 80px;
        object-fit: contain;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.3);
    }

    .weapon-card-name {
        color: #ddd;
        font-size: 0.8rem;
        text-align: center;
        font-weight: 500;
        line-height: 1.2;
        word-break: break-word;
    }

    .weapon-card.selected .weapon-card-name {
        color: #FF9800;
        font-weight: 700;
    }

    /* Enchant Level Buttons */
    .enchant-btn {
        width: 52px;
        height: 42px;
        border: 2px solid rgba(255, 152, 0, 0.3);
        border-radius: 8px;
        background: rgba(30, 30, 30, 0.8);
        color: #ccc;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .enchant-btn:hover {
        border-color: rgba(255, 152, 0, 0.7);
        background: rgba(255, 152, 0, 0.1);
        color: #FF9800;
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(255, 152, 0, 0.2);
    }

    .enchant-btn.selected {
        border-color: #FF9800;
        background: linear-gradient(145deg, rgba(255, 152, 0, 0.3), rgba(255, 120, 0, 0.15));
        color: #FF9800;
        box-shadow: 0 0 15px rgba(255, 152, 0, 0.35);
        text-shadow: 0 0 8px rgba(255, 152, 0, 0.5);
    }
</style>
{% endblock %}